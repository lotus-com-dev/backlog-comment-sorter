# Backlog Comment Sorter

Backlogの課題ページにコメントのソート切り替えボタンを追加するChrome拡張機能です。React + Vite + TypeScriptで実装されています。

## 機能

- Backlogの課題ページに「古い順/新しい順」切り替えボタンを自動追加
- 現在の並び順を自動判別し、適切なボタンラベルを表示
- ワンクリックでコメントの並び順を切り替え可能
- 過去のコメントがある場合は自動的に展開
- 拡張機能のオン/オフ切り替え機能（ポップアップUI）
- 設定の永続保存（Chrome Storage API）
- リロード不要で即座に反映される動的な有効/無効切り替え
- Chrome、Microsoft Edgeなど、Chromiumベースのブラウザで動作

## 開発環境のセットアップ

### 必要な環境
- Node.js (v18以上推奨)
- npm

### インストール手順

1. このリポジトリをクローンします
```bash
git clone https://github.com/yourusername/backlog-comment-sorter.git
cd backlog-comment-sorter
```

2. 依存関係をインストールします
```bash
npm install
```

3. 拡張機能をビルドします
```bash
npm run build
```

### 開発時のコマンド

```bash
# 拡張機能をビルド
npm run build

# 開発サーバーを起動（ホットリロード）
npm run dev

# コードのリント
npm run lint

# プレビューサーバーを起動
npm run preview
```

## Chrome拡張機能としてのインストール方法

1. `npm run build`でビルドを実行します

2. Chrome（またはEdge）で、アドレスバーに `chrome://extensions` と入力して拡張機能管理ページを開きます

3. ページの右上にある「デベロッパー モード」のスイッチをオンにします

4. 「パッケージ化されていない拡張機能を読み込む」ボタンをクリックします

5. ファイル選択ダイアログで、ビルドされた`dist/`フォルダを選択します

6. 拡張機能が読み込まれ、一覧に「Backlog Comment Sorter」が表示されます

## 使い方

### コメントソート機能

1. 拡張機能をインストール後、Backlogの課題ページ（URLに`/view/`を含むページ）にアクセスします

2. ページ上部のフィルターナビゲーションエリアに「古い順で表示」または「新しい順で表示」ボタンが自動的に追加されます

3. ボタンをクリックすることで、コメントの並び順を切り替えることができます

4. ページ間の移動時も、拡張機能が自動的に検知してソートボタンを適切に管理します

### 拡張機能のオン/オフ切り替え

1. ブラウザのツールバーにある拡張機能アイコンをクリックします

2. ポップアップウィンドウが開き、トグルスイッチが表示されます

3. トグルスイッチをクリックして拡張機能の有効/無効を切り替えます
   - 有効時：Backlogページにソートボタンが表示されます
   - 無効時：ソートボタンが非表示になります

4. 設定は自動的に保存され、ページのリロードは不要です

## プロジェクト構成

```
backlog-comment-sorter/
├── src/
│   ├── background/
│   │   └── index.tsx       # バックグラウンドサービスワーカー
│   ├── content/
│   │   └── index.tsx       # コメントソート機能のメインスクリプト
│   └── popup/
│       ├── index.tsx       # ポップアップUIのReactコンポーネント
│       ├── popup.css       # ポップアップUIのスタイル
│       └── popup.html      # ポップアップUIのHTML
├── manifest.json           # Chrome拡張機能マニフェスト
├── vite.config.ts          # Vite設定
├── tsconfig.json           # TypeScript基本設定
├── tsconfig.app.json       # アプリケーション用TypeScript設定
├── tsconfig.node.json      # Node.js用TypeScript設定
├── eslint.config.js        # ESLint設定
├── package.json            # プロジェクト設定と依存関係
├── .gitignore             # Git除外ファイル
└── README.md              # このファイル
```

## 技術スタック

- **React**: UIコンポーネントの構築
- **TypeScript**: 型安全性を確保したJavaScript開発
- **Vite**: 高速なビルドツールとバンドラー
- **@crxjs/vite-plugin**: Vite用Chrome拡張機能開発プラグイン
- **Chrome Extension Manifest V3**: 最新の拡張機能仕様に準拠
- **Chrome Storage API**: 拡張機能の設定を永続的に保存
- **Service Worker**: バックグラウンドでの状態管理とナビゲーション検知
- **Chrome WebNavigation API**: SPA環境でのページ遷移を正確に検知
- **ESLint**: コード品質の維持

## メモリ管理とパフォーマンス最適化

このプロジェクトでは、長時間の使用やSPA（Single Page Application）環境でも安定して動作するよう、以下のメモリリーク対策を実装しています：

### 実装されている最適化

- **React Rootインスタンス管理**: DOM要素削除時の確実なReact Root `unmount()`処理
- **AbortController統合**: 統一されたクリーンアップ管理でイベントリスナーとタイムアウトを確実に削除
- **WeakMap ベースのObserver管理**: 循環参照を排除し、ガベージコレクションを妨げない設計
- **リソース追跡システム**: 開発時にメモリリークを検出・監視する仕組み
- **包括的なエラーハンドリング**: クリーンアップ失敗時のフォールバック処理
- **SPA対応ナビゲーション検知**: WebNavigation APIを活用した正確なページ遷移検知
- **タブベースのメモリ管理**: タブ閉じ時の自動URL情報クリーンアップ
- **メッセージ送信リトライ機能**: コンテンツスクリプトが未準備状態でも確実にメッセージ配信
- **MutationObserver活用**: 効率的なDOM要素の待機処理で初期化の信頼性向上
- **指数バックオフリトライ**: 失敗時の再試行間隔を段階的に延長してリソース効率化
- **イベントデリゲーション**: 動的に追加される要素に対する効率的なイベント処理システム
- **ソートアルゴリズム最適化**: タイムスタンプキャッシュとreverse()による高速ソート処理

### 信頼性向上の取り組み

最新バージョンでは、以下の信頼性向上機能を追加しました：

- **MutationObserver活用**: 従来の定期的なチェックから効率的なDOM監視に変更
- **自動タイムアウト処理**: DOM要素の待機時間に上限設定（10秒）
- **段階的初期化**: 即座に要素が見つからない場合の段階的リトライ機能
- **バックグラウンドメッセージ配信改善**: コンテンツスクリプトの準備状況に応じた配信タイミング調整
- **指数バックオフアルゴリズム**: メッセージ送信失敗時の効率的なリトライパターン

### 開発時のメモリ監視

開発ビルドでは以下の機能が有効になります：

- 30秒間隔でのリソース使用量自動監視
- Observer、Timeout、DOM要素の追跡
- 異常なリソース蓄積の自動検出と警告
- 詳細なデバッグ情報のコンソール出力

これらの最適化により、Backlogページでの長時間使用や頻繁なページ遷移でもメモリ使用量を安定させ、ブラウザのパフォーマンス劣化を防止します。

### ソートアルゴリズムの最適化

コメントソート機能では以下の高度な最適化を実装し、ユーザー体験を大幅に向上させています：

#### タイムスタンプキャッシュシステム
- **WeakMap**を利用したメモリ効率の良い時刻データキャッシュ
- DOM要素への再クエリと日付解析処理を削減
- ガベージコレクションと連動した自動的なメモリ管理

#### インテリジェントソート最適化
- **初回ソート**: 全コメントの時刻解析とソート処理 - O(n log n)
- **再ソート**: コメント変更がない場合は`Array.reverse()`使用 - O(n)
- コメント追加検知時の自動キャッシュクリアによる正確性維持

#### パフォーマンス効果
- **2回目以降のソート**: 最大90%の処理時間短縮
- **DOM操作削減**: 重複する時刻要素クエリを完全排除  
- **メモリ効率**: WeakMapによる循環参照防止とガベージコレクション最適化

この最適化により、特に大量のコメントを含む課題ページでの頻繁なソート操作が劇的に高速化され、ユーザビリティが大幅に改善されます。

## 対応サイト

- `https://*.backlog.jp/*` (課題ページで動作)
- `https://*.backlog.com/*` (課題ページで動作)

**注記**: 拡張機能は全てのBacklogページで読み込まれますが、実際のソート機能は課題ページ（URLに`/view/`を含むページ）でのみ動作します。

## ライセンス

MIT License